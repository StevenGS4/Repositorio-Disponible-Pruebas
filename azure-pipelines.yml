trigger:
  branches:
    include:
      - main
      - develop

pr:
  branches:
    include:
      - main
      - develop

variables:
  - name: vmImageName
    value: 'ubuntu-latest'
  - name: artifactName
    value: 'drop'
  - name: apiDirectory
    value: 'backend'
  - name: webDirectory
    value: 'frontend'
  - name: nodeVersion
    value: '18.x'
  - name: bicepFile
    value: 'infra/bicep/main.bicep'
  - name: Environment
    value: 'dev'
  - name: Location
    value: 'eastus'
  - name: AzureServiceConnection
    value: 'sc-azure-api-prueba'
  - name: SqlAdminLogin
    value: 'sqladminapi'
  - name: SqlAdminPassword
    value: ''
  - name: resourceGroupName
    value: 'rg-api-prueba-errores-$(Environment)'
  - name: webAppName
    value: 'api-prueba-errores-$(Environment)'
  - name: sqlServerName
    value: 'sql-api-prueba-$(Environment)'
  - name: sqlDatabaseName
    value: 'db-api-prueba-$(Environment)'
  - name: storageAccountName
    value: 'stapiprueba$(Environment)'
  - name: EnableStagingSlot
    value: 'false'

stages:
  - stage: Build
    displayName: 'Compilar FrontEnd y BackEnd'
    jobs:
      - job: Build
        pool:
          vmImage: $(vmImageName)
        steps:
          - task: NodeTool@0
            displayName: 'Instalar Node.js $(nodeVersion)'
            inputs:
              versionSpec: '$(nodeVersion)'

          - script: |
              set -e
              cd $(apiDirectory)
              npm ci
              npm run lint
              rm -rf node_modules
              npm ci --omit=dev
              mkdir -p $(Build.ArtifactStagingDirectory)/api
              cp -R . $(Build.ArtifactStagingDirectory)/api
              cd $(Build.ArtifactStagingDirectory)/api
              zip -r ../backend.zip .
            displayName: 'Preparar artefacto del BackEnd'

          - script: |
              set -e
              cd $(webDirectory)
              npm ci
              npm run lint
              npm run build
              mkdir -p $(Build.ArtifactStagingDirectory)/frontend
              cp -R dist $(Build.ArtifactStagingDirectory)/frontend/dist
            displayName: 'Construir FrontEnd PWA'

          - publish: '$(Build.ArtifactStagingDirectory)'
            displayName: 'Publicar artefactos combinados'
            artifact: $(artifactName)

  - stage: Deploy_Infrastructure
    displayName: 'Desplegar infraestructura Azure'
    dependsOn: Build
    jobs:
      - deployment: DeployInfra
        displayName: 'Provisionar recursos base'
        environment: '$(Environment)'
        strategy:
          runOnce:
            deploy:
              steps:
                - download: current
                  artifact: $(artifactName)

                - script: |
                    if [ -z "$(SqlAdminPassword)" ]; then
                      echo "##vso[task.logissue type=error]Define la variable secreta 'SqlAdminPassword' antes de ejecutar el pipeline."
                      exit 1
                    fi
                  displayName: 'Validar credenciales de SQL'

                - task: AzureCLI@2
                  displayName: 'Desplegar infraestructura con Bicep'
                  inputs:
                    azureSubscription: '$(AzureServiceConnection)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      az group create --name $(resourceGroupName) --location $(Location)
                      az deployment group create \
                        --resource-group $(resourceGroupName) \
                        --template-file $(bicepFile) \
                        --parameters \
                          webAppName=$(webAppName) \
                          environment=$(Environment) \
                          location=$(Location) \
                          sqlServerName=$(sqlServerName) \
                          sqlDatabaseName=$(sqlDatabaseName) \
                          enableStagingSlot=$(EnableStagingSlot) \
                          sqlAdminLogin=$(SqlAdminLogin) \
                          sqlAdminPassword=$(SqlAdminPassword) \
                          storageAccountName=$(storageAccountName)

  - stage: Deploy_App
    displayName: 'Desplegar aplicaci칩n'
    dependsOn:
      - Build
      - Deploy_Infrastructure
    jobs:
      - deployment: DeployWeb
        displayName: 'Publicar API y FrontEnd'
        environment: '$(Environment)'
        strategy:
          runOnce:
            deploy:
              steps:
                - download: current
                  artifact: $(artifactName)

                - task: AzureWebApp@1
                  displayName: 'Desplegar API en App Service (slot staging)'
                  condition: eq(variables['EnableStagingSlot'], 'true')
                  inputs:
                    azureSubscription: '$(AzureServiceConnection)'
                    appType: 'webApp'
                    appName: '$(webAppName)'
                    deployToSlotOrASE: true
                    resourceGroupName: '$(resourceGroupName)'
                    slotName: 'staging'
                    package: '$(Pipeline.Workspace)/$(artifactName)/backend.zip'

                - task: AzureWebApp@1
                  displayName: 'Desplegar API en App Service (producci칩n)'
                  condition: ne(variables['EnableStagingSlot'], 'true')
                  inputs:
                    azureSubscription: '$(AzureServiceConnection)'
                    appType: 'webApp'
                    appName: '$(webAppName)'
                    deployToSlotOrASE: false
                    resourceGroupName: '$(resourceGroupName)'
                    package: '$(Pipeline.Workspace)/$(artifactName)/backend.zip'

                - task: AzureCLI@2
                  displayName: 'Publicar FrontEnd est치tico'
                  inputs:
                    azureSubscription: '$(AzureServiceConnection)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      set -e
                      key=$(az storage account keys list --resource-group $(resourceGroupName) --account-name $(storageAccountName) --query "[0].value" -o tsv)
                      az storage blob upload-batch \
                        --account-name $(storageAccountName) \
                        --account-key $key \
                        --destination '$web' \
                        --source $(Pipeline.Workspace)/$(artifactName)/frontend/dist \
                        --overwrite

                - task: AzureAppServiceManage@0
                  displayName: 'Swap staging -> producci칩n'
                  condition: and(succeeded(), eq(variables['Environment'], 'prod'), eq(variables['EnableStagingSlot'], 'true'))
                  inputs:
                    azureSubscription: '$(AzureServiceConnection)'
                    WebAppName: '$(webAppName)'
                    ResourceGroupName: '$(resourceGroupName)'
                    SourceSlot: 'staging'
                    SwapWithProduction: true
